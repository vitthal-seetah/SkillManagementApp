@page
@model SkillManager.Web.Pages.Users.UserSkillsModel
@{
    ViewData["Title"] = "User Skills Overview";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-people-fill me-2"></i>User Skills Overview</h2>
        <a href="/Users/Index" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-1"></i>Back to User Management
        </a>
    </div>

    <!-- 🔍 FILTERS & SORTING -->
    <form method="get" class="row g-3 align-items-end mb-4 p-3 bg-light rounded">
        <!-- Filters -->
        <div class="col-md-3">
            <label for="SelectedUser" class="form-label fw-semibold">Filter by User</label>
            <select name="SelectedUser" id="SelectedUser" class="form-select">
                <option value="All" selected="@(Model.SelectedUser == null || Model.SelectedUser == "All")">All Users</option>
                @foreach (var user in Model.AvailableUsers)
                {
                    <option value="@user.UserId" selected="@(Model.SelectedUser == user.UserId.ToString())">
                        @user.FirstName @user.LastName
                    </option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <label for="SelectedCategory" class="form-label fw-semibold">Category</label>
            <select name="SelectedCategory" id="SelectedCategory" class="form-select">
                <option value="All" selected="@(Model.SelectedCategory == null || Model.SelectedCategory == "All")">All Categories</option>
                @foreach (var category in Model.AvailableCategories)
                {
                    <option value="@category.Id" selected="@(Model.SelectedCategory == category.Id.ToString())">
                        @category.Name
                    </option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <label for="SelectedSkill" class="form-label fw-semibold">Skill Name/Code</label>
            <input type="text" name="SelectedSkill" id="SelectedSkill" class="form-control"
                   value="@Model.SelectedSkill" placeholder="Enter skill..." />
        </div>

        <div class="col-md-2">
            <label for="SelectedLevel" class="form-label fw-semibold">Level</label>
            <select name="SelectedLevel" id="SelectedLevel" class="form-select">
                <option value="All" selected="@(Model.SelectedLevel == null || Model.SelectedLevel == "All")">All Levels</option>
                @foreach (var level in Model.AvailableLevels)
                {
                    <option value="@level" selected="@(Model.SelectedLevel == level)">@level</option>
                }
            </select>
        </div>

        <!-- Sorting -->
        <div class="col-md-2">
            <label for="SortBy" class="form-label fw-semibold">Sort By</label>
            <select name="SortBy" id="SortBy" class="form-select">
                <option value="">Default</option>
                <option value="FirstNameAsc" selected="@(Model.SortBy == "FirstNameAsc")">First Name (A → Z)</option>
                <option value="FirstNameDesc" selected="@(Model.SortBy == "FirstNameDesc")">First Name (Z → A)</option>
                <option value="LastNameAsc" selected="@(Model.SortBy == "LastNameAsc")">Last Name (A → Z)</option>
                <option value="LastNameDesc" selected="@(Model.SortBy == "LastNameDesc")">Last Name (Z → A)</option>
                <option value="FullNameAsc" selected="@(Model.SortBy == "FullNameAsc")">Full Name (A → Z)</option>
                <option value="FullNameDesc" selected="@(Model.SortBy == "FullNameDesc")">Full Name (Z → A)</option>
                <option value="SkillLabelAsc" selected="@(Model.SortBy == "SkillLabelAsc")">Skill Name (A → Z)</option>
                <option value="SkillLabelDesc" selected="@(Model.SortBy == "SkillLabelDesc")">Skill Name (Z → A)</option>
                <option value="SkillCodeAsc" selected="@(Model.SortBy == "SkillCodeAsc")">Skill Code (A → Z)</option>
                <option value="SkillCodeDesc" selected="@(Model.SortBy == "SkillCodeDesc")">Skill Code (Z → A)</option>
                <option value="CategoryNameAsc" selected="@(Model.SortBy == "CategoryNameAsc")">Category (A → Z)</option>
                <option value="CategoryNameDesc" selected="@(Model.SortBy == "CategoryNameDesc")">Category (Z → A)</option>
                <option value="LevelNameAsc" selected="@(Model.SortBy == "LevelNameAsc")">Level Name (A → Z)</option>
                <option value="LevelNameDesc" selected="@(Model.SortBy == "LevelNameDesc")">Level Name (Z → A)</option>
                <option value="LevelPointsAsc" selected="@(Model.SortBy == "LevelPointsAsc")">Level Points (Low → High)</option>
                <option value="LevelPointsDesc" selected="@(Model.SortBy == "LevelPointsDesc")">Level Points (High → Low)</option>
            </select>
        </div>

        <div class="col-md-1">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-funnel me-1"></i>Apply
            </button>
            <a href="/Users/UserSkills" class="btn btn-outline-secondary w-100 mt-2">
                <i class="bi bi-arrow-clockwise me-1"></i>Reset
            </a>
        </div>
    </form>

    <!-- 📊 SUMMARY CARDS -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Users</h6>
                            <h3 class="mb-0">@Model.UserSkills.Select(us => us.UserId).Distinct().Count()</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-people display-6 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Skills</h6>
                            <h3 class="mb-0">@Model.UserSkills.Count</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-tools display-6 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Categories</h6>
                            <h3 class="mb-0">@Model.UserSkills.Select(us => us.CategoryId).Distinct().Count()</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-folder display-6 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Expert Skills</h6>
                            <h3 class="mb-0">@Model.UserSkills.Count(us => us.LevelName == "Expert")</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-star-fill display-6 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 📋 USER SKILLS TABLE -->
    <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-table me-2"></i>User Skills
                <span class="badge bg-light text-dark ms-2">@Model.UserSkills.Count entries</span>
            </h5>
            <div class="text-muted small">
                Page @Model.PageNumber of @Model.TotalPages
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>
                                <a href="@GetSortUrl("FirstName")" class="text-decoration-none text-dark">
                                    User
                                    @Html.Raw(GetSortIcon("FirstName"))
                                </a>
                            </th>
                            <th>
                                <a href="@GetSortUrl("CategoryName")" class="text-decoration-none text-dark">
                                    Category
                                    @Html.Raw(GetSortIcon("CategoryName"))
                                </a>
                            </th>
                            <th>
                                <a href="@GetSortUrl("SkillLabel")" class="text-decoration-none text-dark">
                                    Skill
                                    @Html.Raw(GetSortIcon("SkillLabel"))
                                </a>
                            </th>
                            <th>
                                <a href="@GetSortUrl("LevelName")" class="text-decoration-none text-dark">
                                    Level
                                    @Html.Raw(GetSortIcon("LevelName"))
                                </a>
                            </th>
                            <th>
                                <a href="@GetSortUrl("LevelPoints")" class="text-decoration-none text-dark">
                                    Points
                                    @Html.Raw(GetSortIcon("LevelPoints"))
                                </a>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var userSkill in Model.UserSkills)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-3">
                                            <span class="text-white fw-bold">
                                                @userSkill.FirstName[0]@userSkill.LastName[0]
                                            </span>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">@userSkill.FirstName @userSkill.LastName</div>
                                            <small class="text-muted">ID: @userSkill.UserId</small>
                                        </div>
                                    </div>
                                </td>
                                <td>@userSkill.CategoryName</td>
                                <td>
                                    <div class="fw-semibold">@userSkill.SkillLabel</div>
                                    <small class="text-muted">@userSkill.SkillCode</small>
                                </td>
                                <td>
                                    <span class="badge @GetLevelBadgeClass(userSkill.LevelName) px-3 py-2">
                                        @userSkill.LevelName
                                    </span>
                                </td>
                                <td>
                                    <div class="text-center">
                                        <span class="fw-bold text-primary">@userSkill.LevelPoints</span>
                                        <div class="progress mt-1" style="height: 4px; width: 60px; margin: 0 auto;">
                                            @{
                                                var progressWidth = userSkill.LevelPoints * 25; // 1-4 points = 25%-100%
                                            }
                                            <div class="progress-bar @GetLevelProgressBarClass(userSkill.LevelName)"
                                                 style="width: @progressWidth%"
                                                 title="@userSkill.LevelPoints points">
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }

                        @if (!Model.UserSkills.Any())
                        {
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <i class="bi bi-inbox display-4 text-muted"></i>
                                    <h5 class="mt-3 text-muted">No skills found</h5>
                                    <p class="text-muted">Try adjusting your filters to see more results.</p>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 📄 PAGINATION -->
    @if (Model.TotalPages > 1)
    {
        <nav aria-label="User skills pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                    <a class="page-link"
                       asp-route-PageNumber="@(Model.PageNumber - 1)"
                       asp-route-SelectedUser="@Model.SelectedUser"
                       asp-route-SelectedCategory="@Model.SelectedCategory"
                       asp-route-SelectedSkill="@Model.SelectedSkill"
                       asp-route-SelectedLevel="@Model.SelectedLevel"
                       asp-route-SortBy="@Model.SortBy">Previous</a>
                </li>
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                        <a class="page-link"
                           asp-route-PageNumber="@i"
                           asp-route-SelectedUser="@Model.SelectedUser"
                           asp-route-SelectedCategory="@Model.SelectedCategory"
                           asp-route-SelectedSkill="@Model.SelectedSkill"
                           asp-route-SelectedLevel="@Model.SelectedLevel"
                           asp-route-SortBy="@Model.SortBy">@i</a>
                    </li>
                }
                <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                    <a class="page-link"
                       asp-route-PageNumber="@(Model.PageNumber + 1)"
                       asp-route-SelectedUser="@Model.SelectedUser"
                       asp-route-SelectedCategory="@Model.SelectedCategory"
                       asp-route-SelectedSkill="@Model.SelectedSkill"
                       asp-route-SelectedLevel="@Model.SelectedLevel"
                       asp-route-SortBy="@Model.SortBy">Next</a>
                </li>
            </ul>
        </nav>
    }
</div>

@section Styles {
    <style>
        .avatar-sm {
            width: 40px;
            height: 40px;
            font-size: 0.9rem;
        }

        .avatar-sm {
            width: 40px;
            height: 40px;
            font-size: 0.9rem;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: #495057;
            background-color: #f8f9fa;
        }

            .table th a:hover {
                color: #007bff !important;
            }

        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }

        .progress {
            background-color: #e9ecef;
        }

        /* Adapted Level Badge Styles for Table */
        .badge.level-expert {
            background: linear-gradient(135deg, #FF5722, #e64a19) !important;
            color: white !important;
            border: none;
        }

        .badge.level-maitrise {
            background: linear-gradient(135deg, #9C27B0, #7b1fa2) !important;
            color: white !important;
            border: none;
        }

        .badge.level-pratique {
            background: linear-gradient(135deg, #2196F3, #1976d2) !important;
            color: white !important;
            border: none;
        }

        .badge.level-connaissance {
            background: linear-gradient(135deg, #FFC107, #e6ac00) !important;
            color: white !important;
            border: none;
        }

        /* Progress Bar Colors to Match Level Badges */
        .progress-bar.bg-expert {
            background: linear-gradient(135deg, #FF5722, #e64a19) !important;
        }

        .progress-bar.bg-maitrise {
            background: linear-gradient(135deg, #9C27B0, #7b1fa2) !important;
        }

        .progress-bar.bg-pratique {
            background: linear-gradient(135deg, #2196F3, #1976d2) !important;
        }

        .progress-bar.bg-connaissance {
            background: linear-gradient(135deg, #FFC107, #e6ac00) !important;
        }

        /* Table Row Hover Effects */
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }

        /* Ensure table responsiveness */
        .table-responsive {
            border-radius: 0.375rem;
        }
        .table th {
            border-top: none;
            font-weight: 600;
            color: #495057;
            background-color: #f8f9fa;
        }

            .table th a:hover {
                color: #007bff !important;
            }

        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }

        .progress {
            background-color: #e9ecef;
        }
    </style>
}

@functions {
    private string GetLevelBadgeClass(string levelName)
    {
        return levelName?.ToLower() switch
        {
            "expert" => "level-expert",        // Now returns "level-expert" instead of "bg-success"
            "maitrise" => "level-maitrise",    // Now returns "level-maitrise" instead of "bg-primary"
            "pratique" => "level-pratique",    // Now returns "level-pratique" instead of "bg-info"
            "connaissance" => "level-connaissance", // Now returns "level-connaissance" instead of "bg-warning"
            _ => "level-connaissance"
        };
    }

    private string GetLevelProgressBarClass(string levelName)
    {
        return levelName?.ToLower() switch
        {
            "expert" => "bg-expert",
            "maitrise" => "bg-maitrise",
            "pratique" => "bg-pratique",
            "connaissance" => "bg-connaissance",
            _ => "bg-connaissance"
        };
    }
   
   

    private string GetSortUrl(string sortField)
    {
        var currentSort = Model.SortBy;
        var newSort = "";

        if (currentSort == $"{sortField}Asc")
        {
            newSort = $"{sortField}Desc";
        }
        else
        {
            newSort = $"{sortField}Asc";
        }

        return Url.Page("", new
        {
            SelectedUser = Model.SelectedUser,
            SelectedCategory = Model.SelectedCategory,
            SelectedSkill = Model.SelectedSkill,
            SelectedLevel = Model.SelectedLevel,
            SortBy = newSort,
            PageNumber = 1
        });
    }

    private string GetSortIcon(string sortField)
    {
        var currentSort = Model.SortBy;

        if (currentSort == $"{sortField}Asc")
        {
            return "<i class='bi bi-arrow-up'></i>";
        }
        else if (currentSort == $"{sortField}Desc")
        {
            return "<i class='bi bi-arrow-down'></i>";
        }

        return "<i class='bi bi-arrow-down-up text-muted'></i>";
    }
}