@page
@model SkillManager.Web.Pages.Users.IndexModel
@{
    ViewData["Title"] = "User Management";
    bool isAdmin = Model.Roles.Contains("Admin");
    bool isManager = Model.Roles.Contains("Manager");
    bool canEdit = isAdmin || isManager;
}

<!-- Header with Back Button -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">User Management</h2>
    <a href="Index" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left me-1"></i>Back
    </a>
</div>

@if (isAdmin)
{
    <div class="mb-3 text-end">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createUserModal">
            <i class="bi bi-person-plus"></i> Create New User
        </button>
    </div>
}

<!-- 🔍 FILTER + SORT CONTROLS -->
<form method="get" class="row g-3 align-items-end mb-4">
    <div class="col-auto">
        <label for="SelectedRole" class="form-label fw-semibold">Filter by Role</label>
        <select name="SelectedRole" id="SelectedRole" class="form-select" onchange="this.form.submit()">
            <option value="All" selected="@(Model.SelectedRole == null || Model.SelectedRole == "All")">All Roles</option>
            <option value="Admin" selected="@(Model.SelectedRole == "Admin")">Admin</option>
            <option value="Manager" selected="@(Model.SelectedRole == "Manager")">Manager</option>
            <option value="TechLead" selected="@(Model.SelectedRole == "TechLead")">TechLead</option>
            <option value="Employee" selected="@(Model.SelectedRole == "Employee")">Employee</option>
        </select>
    </div>
    <div class="col-auto">
        <label for="SelectedStatus" class="form-label fw-semibold">Filter by Status</label>
        <select name="SelectedStatus" id="SelectedStatus" class="form-select" onchange="this.form.submit()">
            <option value="All" selected="@(Model.SelectedStatus == null || Model.SelectedStatus == "All")">All Statuses</option>
            @foreach (var value in Enum.GetNames(typeof(SkillManager.Domain.Entities.UserStatus)))
            {
                <option value="@value" selected="@(Model.SelectedStatus == value)">@value</option>
            }
        </select>
    </div>
    <div class="col-auto">
        <label for="SelectedTeam" class="form-label fw-semibold">Filter by Team</label>
        <select name="SelectedTeam" id="SelectedTeam" class="form-select" onchange="this.form.submit()">
            <option value="All" selected="@(Model.SelectedTeam == null || Model.SelectedTeam == "All")">All Teams</option>
            @foreach (var team in Model.AvailableTeams)
            {
                <option value="@team.TeamId" selected="@(Model.SelectedTeam == team.TeamId.ToString())">
                    @team.TeamName
                </option>
            }
        </select>
    </div>

    <div class="col-auto">
        <label for="SelectedDelivery" class="form-label fw-semibold">Filter by Delivery Type</label>
        <select name="SelectedDelivery" id="SelectedDelivery" class="form-select" onchange="this.form.submit()">
            <option value="All" selected="@(Model.SelectedDelivery == null || Model.SelectedDelivery == "All")">All Types</option>
            @foreach (var value in Enum.GetNames(typeof(SkillManager.Domain.Entities.Enums.DeliveryType)))
            {
                <option value="@value" selected="@(Model.SelectedDelivery == value)">@value</option>
            }
        </select>
    </div>
    <div class="col-auto">
        <label for="SortBy" class="form-label fw-semibold">Sort by</label>
        <select name="SortBy" id="SortBy" class="form-select" onchange="this.form.submit()">
            <option value="">Default</option>
            <option value="FirstNameAsc" selected="@(Model.SortBy == "FirstNameAsc")">First Name (A → Z)</option>
            <option value="FirstNameDesc" selected="@(Model.SortBy == "FirstNameDesc")">First Name (Z → A)</option>
            <option value="LastNameAsc" selected="@(Model.SortBy == "LastNameAsc")">Last Name (A → Z)</option>
            <option value="LastNameDesc" selected="@(Model.SortBy == "LastNameDesc")">Last Name (Z → A)</option>
            <option value="FullNameAsc" selected="@(Model.SortBy == "FullNameAsc")">Full Name (A → Z)</option>
            <option value="FullNameDesc" selected="@(Model.SortBy == "FullNameDesc")">Full Name (Z → A)</option>
            <option value="UTCodeAsc" selected="@(Model.SortBy == "UTCodeAsc")">UT Code (A → Z)</option>
            <option value="UTCodeDesc" selected="@(Model.SortBy == "UTCodeDesc")">UT Code (Z → A)</option>
            <option value="RoleAsc" selected="@(Model.SortBy == "RoleAsc")">Role (A → Z)</option>
            <option value="RoleDesc" selected="@(Model.SortBy == "RoleDesc")">Role (Z → A)</option>
            <!-- Add Team sorting options -->
            <option value="TeamAsc" selected="@(Model.SortBy == "TeamAsc")">Team Name (A → Z)</option>
            <option value="TeamDesc" selected="@(Model.SortBy == "TeamDesc")">Team Name (Z → A)</option>
        </select>
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-primary">Apply</button>
        <a href="/Users/Index" class="btn btn-outline-secondary">Reset</a>
    </div>
</form>

<!-- ✅ Success/Error Alerts -->
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        <ul class="mb-0">
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
    </div>
}

<!-- 👥 USER TABLE -->
<div class="card">
    <div class="card-header bg-black">
        <h5 class="card-title mb-0 text-white">
            <i class="fas fa-users me-2"></i>Users
            <span class="badge bg-light text-dark ms-2">@Model.TotalUsersCount entries</span>
        </h5>
    </div>
    <div class="card-body p-0">
        <!-- 👥 USER TABLE -->
        <div class="table-responsive" style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
            <table class="table table-hover align-middle mb-0" style="min-width:1300px;">
                <thead class="table-light">
                    <tr>
                        <th style="min-width:140px;">
                            <a asp-page="Index"
                               asp-route-SortBy="@(Model.SortBy == "FirstNameAsc" ? "FirstNameDesc" : "FirstNameAsc")"
                               asp-route-SelectedRole="@Model.SelectedRole"
                               asp-route-SelectedStatus="@Model.SelectedStatus"
                               asp-route-SelectedDelivery="@Model.SelectedDelivery"
                               asp-route-SelectedTeam="@Model.SelectedTeam"
                               class="text-decoration-none text-dark fw-semibold">
                                First Name @Html.Raw(GetSortIcon("FirstName"))
                            </a>
                        </th>

                        <th style="min-width:140px;">
                            <a asp-page="Index"
                               asp-route-SortBy="@(Model.SortBy == "LastNameAsc" ? "LastNameDesc" : "LastNameAsc")"
                               asp-route-SelectedRole="@Model.SelectedRole"
                               asp-route-SelectedStatus="@Model.SelectedStatus"
                               asp-route-SelectedDelivery="@Model.SelectedDelivery"
                               asp-route-SelectedTeam="@Model.SelectedTeam"
                               class="text-decoration-none text-dark fw-semibold">
                                Last Name @Html.Raw(GetSortIcon("LastName"))
                            </a>
                        </th>

                        <th style="min-width:70px;">Domain</th>

                        <th style="min-width:150px;">
                            <a asp-page="Index"
                               asp-route-SortBy="@(Model.SortBy == "EidAsc" ? "EidDesc" : "EidAsc")"
                               asp-route-SelectedRole="@Model.SelectedRole"
                               asp-route-SelectedStatus="@Model.SelectedStatus"
                               asp-route-SelectedDelivery="@Model.SelectedDelivery"
                               asp-route-SelectedTeam="@Model.SelectedTeam"
                               class="text-decoration-none text-dark fw-semibold">
                                EID @Html.Raw(GetSortIcon("Eid"))
                            </a>
                        </th>

                        <th style="min-width:140px;">Status</th>

                        <th style="min-width:130px;">Delivery Type</th>

                        <th style="min-width:120px;">
                            <a asp-page="Index"
                               asp-route-SortBy="@(Model.SortBy == "UtCodeAsc" ? "UtCodeDesc" : "UtCodeAsc")"
                               asp-route-SelectedRole="@Model.SelectedRole"
                               asp-route-SelectedStatus="@Model.SelectedStatus"
                               asp-route-SelectedDelivery="@Model.SelectedDelivery"
                               asp-route-SelectedTeam="@Model.SelectedTeam"
                               class="text-decoration-none text-dark fw-semibold">
                                UT Code @Html.Raw(GetSortIcon("UtCode"))
                            </a>
                        </th>
                        <th style="min-width:120px;">Team</th>

                        <th style="min-width:120px;">Ref ID</th>

                        <th style="min-width:140px;">
                            <a asp-page="Index"
                               asp-route-SortBy="@(Model.SortBy == "RoleAsc" ? "RoleDesc" : "RoleAsc")"
                               asp-route-SelectedRole="@Model.SelectedRole"
                               asp-route-SelectedStatus="@Model.SelectedStatus"
                               asp-route-SelectedDelivery="@Model.SelectedDelivery"
                               asp-route-SelectedTeam="@Model.SelectedTeam"
                               class="text-decoration-none text-dark fw-semibold">
                                Role @Html.Raw(GetSortIcon("Role"))
                            </a>
                        </th>

                        @if (canEdit)
                        {
                            <th style="min-width:140px; width:140px;">Actions</th>
                        }
                    </tr>
                </thead>

                <tbody>
                    @foreach (var user in Model.Users)
                    {
                        var rowId = $"row-{user.UserId}";
                        string role = user.RoleName ?? "Employee";

                        <tr id="@rowId">
                            <form method="post" asp-page-handler="Save" class="user-form">
                                <input type="hidden" name="userId" value="@user.UserId" />

                            <td><input name="firstName" class="form-control" value="@user.FirstName" disabled /><div class="invalid-feedback"></div></td>

                            <td><input name="lastName" class="form-control" value="@user.LastName" disabled /><div class="invalid-feedback"></div></td>

                            <td>
                                @if (isAdmin || isManager)
                                {
                                    <input name="domain" class="form-control" value="@user.Domain" disabled />
                                    <div class="invalid-feedback"></div>
                                }
                                else
                                {
                                    <input type="hidden" name="domain" value="@user.Domain" />
                                    <input class="form-control" value="@user.Domain" disabled />
                                    <div class="invalid-feedback"></div>
                                }
                            </td>

                            <td>
                                @if (isAdmin || isManager)
                                {
                                    <input name="eid" class="form-control" value="@user.Eid" disabled />
                                    <div class="invalid-feedback"></div>
                                }
                                else
                                {
                                    <input type="hidden" name="eid" value="@user.Eid" />
                                    <input class="form-control" value="@user.Eid" disabled />
                                    <div class="invalid-feedback"></div>
                                }
                            </td>

                            <td>
                                <select name="status" class="form-select" disabled>
                                    @foreach (var value in Enum.GetValues(typeof(SkillManager.Domain.Entities.UserStatus)))
                                    {
                                        <option value="@value" selected="@(user.Status == (SkillManager.Domain.Entities.UserStatus)value)">
                                            @value
                                        </option>
                                    }
                                </select>
                                <div class="invalid-feedback"></div>
                            </td>

                            <td>
                                <select name="deliveryType" class="form-select" disabled>
                                    @foreach (var value in Enum.GetValues(typeof(SkillManager.Domain.Entities.Enums.DeliveryType)))
                                    {
                                        <option value="@value" selected="@(user.DeliveryType == (SkillManager.Domain.Entities.Enums.DeliveryType)value)">
                                            @value
                                        </option>
                                    }
                                </select>
                                <div class="invalid-feedback"></div>
                            </td>

                            <td>
                                @if (isAdmin)
                                {
                                    <input name="utCode" class="form-control" value="@user.UtCode" disabled />
                                    <div class="invalid-feedback"></div>
                                }
                                else
                                {
                                    <input type="hidden" name="utCode" value="@user.UtCode" />
                                    <span class="form-control-plaintext">@user.UtCode</span>
                                }
                            </td>
                            <td>
                                @if (isAdmin)
                                {
                                    <select name="teamId" class="form-select" disabled>
                                        <option value="">No Team</option>
                                        @foreach (var team in Model.AvailableTeams)
                                        {
                                            <option value="@team.TeamId" selected="@(user.TeamName == team.TeamName)">
                                                @team.TeamName
                                            </option>
                                        }
                                    </select>
                                    <div class="invalid-feedback"></div>
                                }
                                else
                                {
                                    <input type="hidden" name="teamId" value="@(user.TeamName?.ToString() ?? "")" />
                                    <span class="form-control-plaintext">@user.TeamName</span>
                                }
                            </td>
                            <td>
                                @if (isAdmin)
                                {
                                    <input name="refId" class="form-control" value="@user.RefId" disabled />
                                    <div class="invalid-feedback"></div>
                                }
                                else
                                {
                                    <input type="hidden" name="refId" value="@user.RefId" />
                                    <span class="form-control-plaintext">@user.RefId</span>
                                }
                            </td>


                            <td>
                                @if (isAdmin)
                                {
                                    <select name="roleName" class="form-select" disabled>
                                        <div class="invalid-feedback"></div>
                                        <option value="Employee" selected="@(role == "Employee")">Employee</option>
                                        <option value="TechLead" selected="@(role == "TechLead")">TechLead</option>
                                        <option value="Manager" selected="@(role == "Manager")">Manager</option>
                                        <option value="Admin" selected="@(role == "Admin")">Admin</option>
                                    </select>
                                }
                                else
                                {
                                    <span class="badge @GetRoleBadgeClass(role) px-3 py-2">@role</span>
                                }
                            </td>

                            @if (canEdit)
                            {
                                <td style="white-space:nowrap;">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary edit-btn" onclick="enableEdit('@rowId')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="submit" class="btn btn-outline-success save-btn d-none">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary cancel-btn d-none" onclick="cancelEdit('@rowId')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </td>
                            }
                            </form>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

    <!-- 🧍 CREATE USER MODAL -->
    <div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form method="post" asp-page-handler="Create">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="createUserLabel">Create New User</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">First Name</label>
                            <input name="firstName" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Last Name</label>
                            <input name="lastName" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Domain</label>
                            <input name="domain" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">EID</label>
                            <input name="eid" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Status</label>
                            <select name="status" class="form-select">
                                @foreach (var value in Enum.GetValues(typeof(SkillManager.Domain.Entities.UserStatus)))
                                {
                                    <option value="@value">@value</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Delivery Type</label>
                            <select name="deliveryType" class="form-select">
                                @foreach (var value in Enum.GetValues(typeof(SkillManager.Domain.Entities.Enums.DeliveryType)))
                                {
                                    <option value="@value">@value</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">UT Code</label>
                            <input name="utCode" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Ref ID</label>
                            <input name="refId" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Role</label>
                            <select name="roleName" class="form-select">
                                <option value="Employee">Employee</option>
                                <option value="TechLead">TechLead</option>
                                <option value="Manager">Manager</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 📄 PAGINATION -->
@if (Model.TotalPages > 1)
{
        <nav aria-label="User pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                    <a class="page-link" asp-route-PageNumber="@(Model.PageNumber - 1)"
                       asp-route-SelectedRole="@Model.SelectedRole"
                       asp-route-SelectedStatus="@Model.SelectedStatus"
                       asp-route-SelectedDelivery="@Model.SelectedDelivery"
                       asp-route-SortBy="@Model.SortBy">Previous</a>
                </li>
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                        <a class="page-link" asp-route-PageNumber="@i"
                           asp-route-SelectedRole="@Model.SelectedRole"
                           asp-route-SelectedStatus="@Model.SelectedStatus"
                           asp-route-SelectedDelivery="@Model.SelectedDelivery"
                           asp-route-SortBy="@Model.SortBy">@i</a>
                    </li>
                }
                <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                    <a class="page-link" asp-route-PageNumber="@(Model.PageNumber + 1)"
                       asp-route-SelectedRole="@Model.SelectedRole"
                       asp-route-SelectedStatus="@Model.SelectedStatus"
                       asp-route-SelectedDelivery="@Model.SelectedDelivery"
                       asp-route-SortBy="@Model.SortBy">Next</a>
                </li>
            </ul>
        </nav>
}

@section Scripts {
        <style>
            .bg-purple {
                background-color: rebeccapurple !important;
                color: white !important;
            }

            .badge {
                font-size: 0.9rem;
                border-radius: 0.5rem;
            }

            form.row.g-3 select {
                min-width: 150px;
            }

            .btn-group {
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        </style>
        <script>
            let originalValues = {};

            function enableEdit(rowId) {
                const row = document.getElementById(rowId);
                const inputs = row.querySelectorAll("input, select");
                const editBtn = row.querySelector(".edit-btn");
                const saveBtn = row.querySelector(".save-btn");
                const cancelBtn = row.querySelector(".cancel-btn");

                // Store original values
                originalValues[rowId] = {};
                inputs.forEach(input => {
                    if (input.type !== 'hidden') {
                        originalValues[rowId][input.name] = input.value;
                    }
                });

                // Enable inputs
                inputs.forEach(i => {
                    if (i.type !== "hidden" && !i.classList.contains('form-control-plaintext')) {
                        i.disabled = false;
                    }
                });

                // Toggle buttons
                editBtn.classList.add("d-none");
                saveBtn.classList.remove("d-none");
                cancelBtn.classList.remove("d-none");
            }

            function cancelEdit(rowId) {
                const row = document.getElementById(rowId);
                const inputs = row.querySelectorAll("input, select");
                const editBtn = row.querySelector(".edit-btn");
                const saveBtn = row.querySelector(".save-btn");
                const cancelBtn = row.querySelector(".cancel-btn");

                // Restore original values
                if (originalValues[rowId]) {
                    inputs.forEach(input => {
                        if (originalValues[rowId][input.name] !== undefined &&
                            input.type !== 'hidden' &&
                            !input.classList.contains('form-control-plaintext')) {
                            input.value = originalValues[rowId][input.name];
                        }
                    });
                }

                // Disable inputs
                inputs.forEach(i => {
                    if (i.type !== "hidden" && !i.classList.contains('form-control-plaintext')) {
                        i.disabled = true;
                    }
                });

                // Toggle buttons
                editBtn.classList.remove("d-none");
                saveBtn.classList.add("d-none");
                cancelBtn.classList.add("d-none");

                // Clear validation
                const invalidFeedback = row.querySelectorAll('.invalid-feedback');
                invalidFeedback.forEach(feedback => {
                    feedback.textContent = '';
                });
                inputs.forEach(input => {
                    input.classList.remove('is-invalid');
                });
            }

            // Handle form submission
            document.addEventListener('DOMContentLoaded', function() {
                const forms = document.querySelectorAll('.user-form');
                forms.forEach(form => {
                    form.addEventListener('submit', function(e) {
                        const rowId = this.closest('tr').id;
                        const saveBtn = this.querySelector('.save-btn');

                        // If save button is visible, we're in edit mode
                        if (!saveBtn.classList.contains('d-none')) {
                            // You can add validation here if needed
                            console.log('Saving user data for row:', rowId);
                        }
                    });
                });
            });
        </script>
}

@functions {
    private string GetRoleBadgeClass(string role)
    {
        return role switch
        {
            "Admin" => "bg-danger text-white",
            "Manager" => "bg-primary text-white",
            "TechLead" => "bg-purple text-white",
            "Employee" => "bg-success text-white",
            _ => "bg-secondary text-white"
        };
    }


    private string GetSortIcon(string sortField)
    {
        var currentSort = Model.SortBy;

        if (currentSort == $"{sortField}Asc")
        {
            return "<i class='bi bi-arrow-up'></i>";
        }
        else if (currentSort == $"{sortField}Desc")
        {
            return "<i class='bi bi-arrow-down'></i>";
        }

        return "<i class='bi bi-arrow-down-up text-muted'></i>";
    }




}
